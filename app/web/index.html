<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DNS Dashboard</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
      h2 { margin: 24px 0 8px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; }
      th { background: #f5f5f5; text-align: left; }
      .section { margin-bottom: 28px; }
      .muted { color: #666; }
      .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
      .blocked { background: #ffe6e6; color: #a00; }
      .ok { background: #e6ffe6; color: #0a0; }
      .row { display: flex; gap: 16px; }
      .col { flex: 1; }
      .logs-container { max-height: 480px; overflow: auto; }
      .loading { text-align: center; padding: 40px; }
      .error { color: red; padding: 20px; text-align: center; }
      .retry-btn { padding: 10px 20px; margin-top: 10px; }
    </style>
  </head>
  <body>
    <h1>DNS Dashboard</h1>
    <div id="app"></div>

    <script>
      // 简化的状态管理
      let state = {
        logs: [],
        topClients: [],
        blockedStats: [],
        loading: true,
        error: null
      };

      let listeners = [];

      function setState(newState) {
        state = { ...state, ...newState };
        listeners.forEach(listener => listener());
      }

      function subscribe(listener) {
        listeners.push(listener);
        return () => {
          listeners = listeners.filter(l => l !== listener);
        };
      }

      // API调用函数
      async function fetchData() {
        try {
          setState({ error: null });
          
          const [logsRes, topRes, blkRes] = await Promise.all([
            fetch('/api/logs'),
            fetch('/api/top-clients'),
            fetch('/api/blocked-stats')
          ]);
          
          let logs = [];
          let topClients = [];
          let blockedStats = [];
          
          if (logsRes.ok) {
            const logsData = await logsRes.json();
            logs = Array.isArray(logsData) ? logsData : [];
          } else {
            console.error('获取日志失败:', logsRes.status, logsRes.statusText);
          }
          
          if (topRes.ok) {
            const topData = await topRes.json();
            topClients = Array.isArray(topData) ? topData : [];
          } else {
            console.error('获取客户端统计失败:', topRes.status, topRes.statusText);
          }
          
          if (blkRes.ok) {
            const blkData = await blkRes.json();
            blockedStats = Array.isArray(blkData) ? blkData : [];
          } else {
            console.error('获取阻止统计失败:', blkRes.status, blkRes.statusText);
          }
          
          setState({ logs, topClients, blockedStats, loading: false });
        } catch (error) {
          console.error('获取数据时发生错误:', error);
          setState({ error: error.message, loading: false });
        }
      }

      // 渲染函数
      function render() {
        const app = document.getElementById('app');
        
        if (state.error) {
          app.innerHTML = `
            <div class="error">
              <h2>加载数据时发生错误</h2>
              <p>${state.error}</p>
              <button class="retry-btn" onclick="retry()">重试</button>
            </div>
          `;
          return;
        }
        
        if (state.loading) {
          app.innerHTML = '<div class="loading"><h2>正在加载数据...</h2></div>';
          return;
        }
        
        const displayedLogs = state.logs.slice(0, 100);
        
        app.innerHTML = `
          <div class="section">
            <h2>Query Logs</h2>
            <div class="logs-container">
              <table>
                <thead>
                  <tr>
                    <th>time</th><th>client</th><th>country</th><th>proto</th>
                    <th>id</th><th>qname</th><th>qtype</th><th>rcode</th>
                    <th>answers</th><th>rtt(ms)</th><th>blocked</th><th>error</th>
                  </tr>
                </thead>
                <tbody>
                  ${displayedLogs.map(r => `
                    <tr>
                      <td>${r.time || ''}</td>
                      <td>${r.client_ip || ''}</td>
                      <td>${r.country || ''}</td>
                      <td>${r.proto || ''}</td>
                      <td>${r.id || ''}</td>
                      <td>${r.qname || ''}</td>
                      <td>${r.qtype || ''}</td>
                      <td>${r.rcode || ''}</td>
                      <td class="muted">${r.answers || ''}</td>
                      <td>${r.rtt_ms ? (typeof r.rtt_ms === 'number' ? r.rtt_ms.toFixed(2) : r.rtt_ms) : ''}</td>
                      <td><span class="badge ${r.blocked ? 'blocked' : 'ok'}">${r.blocked ? 'blocked' : 'ok'}</span></td>
                      <td class="muted">${r.error || ''}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="section">
            <h2>Top 10 Clients (24h)</h2>
            <table>
              <thead>
                <tr><th>client_ip</th><th>country</th><th>count</th></tr>
              </thead>
              <tbody>
                ${state.topClients.map(r => `
                  <tr>
                    <td>${r.client_ip || ''}</td>
                    <td>${r.country || ''}</td>
                    <td>${r.count || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div class="section">
            <h2>Blocked Domains Stats (All time)</h2>
            <table>
              <thead>
                <tr><th>qname</th><th>country</th><th>count</th></tr>
              </thead>
              <tbody>
                ${state.blockedStats.map(r => `
                  <tr>
                    <td>${r.qname || ''}</td>
                    <td>${r.country || ''}</td>
                    <td>${r.count || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }

      // 重试函数
      function retry() {
        setState({ error: null, loading: true });
        fetchData();
      }

      // 初始化
      subscribe(render);
      fetchData();
      
      // 每5秒刷新一次数据
      setInterval(fetchData, 5000);
    </script>
  </body>
</html>